<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Registrasi Buka Puasa Bersama 1447 H</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Open+Sans:wght@400;500;600&display=swap" rel="stylesheet">

<style>
/* RESET & BASE STYLES */
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
  background: #f7f7f8;
  color: #343541;
  line-height: 1.6;
  min-height: 100vh;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

main {
  padding: 2rem 1rem;
}

.container {
  max-width: 500px;
  margin: 0 auto;
}

/* HEADER STYLES */
.header {
  text-align: center;
  margin-bottom: 2rem;
  padding: 0 0.5rem;
}

.header h1 {
  margin: 0 0 0.75rem 0;
  font-size: 1.75rem;
  color: #202123;
  font-weight: 600;
  letter-spacing: -0.01em;
  line-height: 1.3;
}

.header .center-name {
  color: #565869;
  font-weight: 500;
  font-size: 1rem;
  margin-bottom: 0.75rem;
}

.header .subtitle {
  color: #6e6e80;
  font-size: 0.875rem;
  font-weight: 400;
  line-height: 1.5;
}

/* CARD STYLES */
.card {
  background: #ffffff;
  padding: 2rem;
  border-radius: 12px;
  border: 1px solid #e5e5e5;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05), 0 1px 2px rgba(0, 0, 0, 0.1);
  margin-bottom: 2rem;
  transition: all 0.2s ease;
}

.card:hover {
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05), 0 1px 3px rgba(0, 0, 0, 0.1);
}

/* FORM FIELD STYLES */
.field {
  margin-bottom: 1.5rem;
}

label {
  display: block;
  margin-bottom: 0.5rem;
  font-weight: 500;
  font-size: 0.875rem;
  color: #374151;
  letter-spacing: -0.01em;
}

.input-wrapper {
  position: relative;
}

.input-wrapper i {
  position: absolute;
  left: 1rem;
  top: 50%;
  transform: translateY(-50%);
  color: #9ca3af;
  font-size: 1rem;
}

input, select {
  width: 100%;
  padding: 0.875rem 1rem 0.875rem 3rem;
  border-radius: 8px;
  border: 1px solid #d1d5db;
  font-size: 0.9375rem;
  font-family: 'Inter', sans-serif;
  background: #ffffff;
  transition: all 0.2s ease;
  color: #374151;
}

input:focus, select:focus {
  outline: none;
  border-color: #10a37f;
  box-shadow: 0 0 0 2px rgba(16, 163, 127, 0.1);
  background: #ffffff;
}

/* SELECT STYLES */
select {
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%239ca3af'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 1rem center;
  background-size: 1.25rem;
  padding-right: 3rem;
  cursor: pointer;
}

/* RADIO & TOGGLE BUTTON STYLES */
.radio-group, .toggle-group {
  display: flex;
  gap: 0.75rem;
}

.radio-group input, .toggle-group input {
  display: none;
}

.radio-group label, .toggle-group label {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  padding: 0.875rem 1rem;
  border-radius: 8px;
  border: 1px solid #d1d5db;
  background: #f9fafb;
  font-size: 0.875rem;
  font-weight: 500;
  color: #4b5563;
  cursor: pointer;
  transition: all 0.2s ease;
  margin-bottom: 0;
}

.radio-group label i, .toggle-group label i {
  position: static;
  transform: none;
  font-size: 1rem;
}

.radio-group input:checked + label,
.toggle-group input:checked + label {
  background: #d1fae5;
  border-color: #10a37f;
  color: #065f46;
  font-weight: 500;
}

/* OTP CONTAINER */
.otp-container {
  display: flex;
  gap: 0.75rem;
  align-items: center;
}

.otp-container .input-wrapper {
  flex: 1;
}

.btn-otp {
  padding: 0.875rem 1.5rem;
  background: #10a37f;
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 0.875rem;
  font-weight: 500;
  cursor: pointer;
  white-space: nowrap;
  transition: all 0.2s ease;
  font-family: 'Inter', sans-serif;
  min-width: 120px;
}

.btn-otp:hover {
  background: #0d8c6d;
}

.btn-otp:disabled {
  background: #d1d5db;
  cursor: not-allowed;
}

/* HINT TEXT */
.hint {
  font-size: 0.75rem;
  color: #6b7280;
  margin-top: 0.375rem;
  line-height: 1.4;
}

/* ROW LAYOUT */
.row {
  display: flex;
  gap: 1rem;
}

.row .field {
  flex: 1;
}

/* OTP FIELD */
.otp-field {
  display: none;
  background: #f0fdf4;
  padding: 1rem;
  border-radius: 8px;
  border: 1px dashed #10a37f;
  margin-bottom: 1.5rem;
}

.otp-field.active {
  display: block;
}

/* OTHER NATIONALITY FIELD */
.other-nationality-wrapper {
  display: none;
  margin-top: 0.75rem;
}

.other-nationality-wrapper.active {
  display: block;
}

/* CHILDREN FIELD */
.children-field-wrapper {
  display: none;
  margin-top: 0.75rem;
}

.children-field-wrapper.active {
  display: block;
}

/* TOTAL SUMMARY */
.total-summary {
  background: #f9fafb;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  padding: 1.5rem;
  margin-top: 1.5rem;
  text-align: center;
}

.total-number {
  font-size: 2rem;
  font-weight: 600;
  color: #111827;
  margin: 0.5rem 0;
  font-family: 'Inter', sans-serif;
}

.total-label {
  font-size: 0.875rem;
  color: #4b5563;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  font-weight: 500;
}

.total-label i {
  color: #10a37f;
}

/* CONSENT CHECKBOX */
.consent {
  display: flex;
  gap: 0.75rem;
  padding: 1rem;
  background: #f9fafb;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  margin: 1.5rem 0;
  align-items: flex-start;
}

.consent input {
  width: 1.25rem;
  height: 1.25rem;
  margin-top: 0.125rem;
  flex-shrink: 0;
  border-radius: 4px;
  accent-color: #10a37f;
}

.consent span {
  font-size: 0.875rem;
  color: #374151;
  line-height: 1.5;
}

/* BUTTON */
.submit-btn {
  width: 100%;
  padding: 1rem;
  background: #10a37f;
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 0.9375rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
  font-family: 'Inter', sans-serif;
}

.submit-btn:hover {
  background: #0d8c6d;
}

.submit-btn:disabled {
  background: #d1d5db;
  cursor: not-allowed;
}

/* ALERT */
.alert {
  display: none;
  background: #fef2f2;
  color: #dc2626;
  padding: 1rem;
  border-radius: 8px;
  border: 1px solid #fecaca;
  margin-bottom: 1.5rem;
  text-align: center;
  font-size: 0.875rem;
}

.alert.active {
  display: block;
}

/* FOOTER */
footer {
  text-align: center;
  color: #6b7280;
  font-size: 0.875rem;
  padding: 1rem 0;
  border-top: 1px solid #e5e7eb;
  margin-top: 2rem;
}

/* RESPONSIVE */
@media (max-width: 640px) {
  main {
    padding: 1.5rem 1rem;
  }
  
  .card {
    padding: 1.5rem;
  }
  
  .row {
    flex-direction: column;
    gap: 0.75rem;
  }
  
  .otp-container {
    flex-direction: column;
    gap: 0.75rem;
    align-items: stretch;
  }
  
  .btn-otp {
    width: 100%;
    padding: 0.75rem;
    font-size: 0.85rem;
    min-width: unset;
  }
  
  .otp-container .input-wrapper {
    width: 100%;
  }
  
  input, select {
    padding: 0.75rem 0.875rem 0.75rem 2.75rem;
    font-size: 0.9rem;
  }
  
  .input-wrapper i {
    left: 0.875rem;
    font-size: 0.9rem;
  }
  
  .otp-field {
    padding: 0.875rem;
  }
  
  .total-summary {
    padding: 1.25rem;
  }
  
  .total-number {
    font-size: 1.75rem;
  }
}

/* LOADING SPINNER */
.loading-spinner {
  display: inline-block;
  width: 1rem;
  height: 1rem;
  border: 2px solid rgba(255, 255, 255, 0.3);
  border-radius: 50%;
  border-top-color: #fff;
  animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}
</style>
</head>

<body>
<main>
  <div class="container">
    <!-- Duplicate Alert -->
    <div class="alert" id="duplicateAlert">
      <span data-id="Data ini sudah terdaftar" 
            data-en="This data is already registered" 
            data-ja="すでに登録されています"></span>
    </div>

    <!-- Header -->
    <div class="header">
      <h1 data-id="Registrasi Buka Puasa Bersama 1447 H"
          data-en="Ramadan Iftar Registration 1447 AH"
          data-ja="1447年 ラマダン・イフタール参加登録"></h1>
      <div class="center-name" 
           data-id="Yayasan Ibadurrahman Islamic Center"
           data-en="Ibadurrahman Islamic Center Foundation"
           data-ja="イバドゥッラフマン・イスラムセンター財団"></div>
      <div class="subtitle"
           data-id="Silakan lengkapi formulir registrasi di bawah ini"
           data-en="Please complete the registration form below"
           data-ja="以下の登録フォームにご記入ください"></div>
    </div>

    <!-- Registration Form -->
    <div class="card">
      <form id="registrationForm">
        <!-- Full Name -->
        <div class="field">
          <label data-id="Nama Lengkap" data-en="Full Name" data-ja="氏名"></label>
          <div class="input-wrapper">
            <i class="fas fa-user"></i>
            <input type="text" id="nama_lengkap" name="nama_lengkap" required
                   data-id-ph="Nama sesuai identitas"
                   data-en-ph="Name as shown on ID"
                   data-ja-ph="身分証通りの氏名">
          </div>
        </div>

        <!-- Email -->
        <div class="field">
          <label data-id="Alamat Email" data-en="Email Address" data-ja="メールアドレス"></label>
          <div class="otp-container">
            <div class="input-wrapper">
              <i class="fas fa-envelope"></i>
              <input type="email" id="email" name="email" required
                     data-id-ph="contoh@email.com"
                     data-en-ph="example@email.com"
                     data-ja-ph="例: example@email.com">
            </div>
            <button type="button" class="btn-otp" id="sendOtpBtn" aria-label="Send OTP">
              <span data-id="Kirim OTP" data-en="Send OTP" data-ja="OTP送信"></span>
            </button>
          </div>
          <div class="hint"
               data-id="Kode OTP akan dikirim ke email ini"
               data-en="OTP code will be sent to this email"
               data-ja="OTPコードはこのメールに送信されます"></div>
        </div>

        <!-- OTP Field -->
        <div class="otp-field" id="otpField">
          <label data-id="Kode OTP" data-en="OTP Code" data-ja="OTPコード"></label>
          <div class="input-wrapper">
            <i class="fas fa-key"></i>
            <input type="tel" id="otp_input" inputmode="numeric" pattern="[0-9]{6}" maxlength="6"
                   data-id-ph="Masukkan 6 digit kode"
                   data-en-ph="Enter 6-digit code"
                   data-ja-ph="6桁のコードを入力">
          </div>
          <div class="hint" id="otpHint"
               data-id="Periksa inbox atau spam folder email Anda"
               data-en="Check your inbox or spam folder"
               data-ja="受信トレイまたはスパムフォルダをご確認ください"></div>
        </div>

        <!-- Phone Number -->
        <div class="field">
          <label data-id="Nomor Telepon" data-en="Phone Number" data-ja="電話番号"></label>
          <div class="input-wrapper">
            <i class="fas fa-phone"></i>
            <input type="tel" id="no_hp" name="no_hp" required pattern="[0-9]{10,15}"
                   data-id-ph="081234567890"
                   data-en-ph="081234567890"
                   data-ja-ph="08012345678">
          </div>
          <div class="hint"
               data-id="Gunakan nomor aktif yang dapat dihubungi"
               data-en="Use an active contact number"
               data-ja="連絡可能な番号を入力してください"></div>
        </div>

        <!-- Residence -->
        <div class="field">
          <label data-id="Domisili" data-en="Residence" data-ja="居住地"></label>
          <div class="input-wrapper">
            <i class="fas fa-map-marker-alt"></i>
            <input type="text" id="domisili" name="domisili" list="neighborhoods" required autocomplete="off"
                   data-id-ph="Cari nama kelurahan/kecamatan"
                   data-en-ph="Search for neighborhood/district"
                   data-ja-ph="町名・地区名を検索">
            <datalist id="neighborhoods">
              <option value="Okayama-shi, Kita-ku, Kaminakano">
              <option value="Okayama-shi, Kita-ku, Ima">
              <option value="Okayama-shi, Kita-ku, Omoto">
              <option value="Okayama-shi, Kita-ku, Tsushima">
              <option value="Okayama-shi, Kita-ku, Hokan-cho">
              <option value="Okayama-shi, Naka-ku, Nishigawara">
              <option value="Okayama-shi, Minami-ku, Toyonari">
              <option value="Kurashiki-shi, Achi">
              <option value="Kurashiki-shi, Nakasho">
              <option value="Kurashiki-shi, Chaya-machi">
              <option value="Kurashiki-shi, Mizushima">
              <option value="Kurashiki-shi, Kojima">
              <option value="Kurashiki-shi, Tamashima">
              <option value="Tamano-shi, Chikko">
              <option value="Tamano-shi, Uno">
              <option value="Tamano-shi, Hibibi">
              <option value="Tamano-shi, Shibukawa">
              <option value="Soja-shi, Chuo">
              <option value="Soja-shi, Kiyone">
              <option value="Soja-shi, Yamate">
              <option value="Akaiwa-shi, Sanyo">
              <option value="Setouchi-shi, Oku-cho">
            </datalist>
          </div>
        </div>

        <!-- Nationality -->
        <div class="field">
          <label data-id="Kebangsaan" data-en="Nationality" data-ja="国籍"></label>
          <div class="input-wrapper">
            <i class="fas fa-globe"></i>
            <select id="kebangsaan" name="kebangsaan" required>
              <option value=""
                      data-id="Pilih kebangsaan"
                      data-en="Select nationality"
                      data-ja="国籍を選択">
              </option>
              <option value="Indonesia"
                      data-id="Indonesia"
                      data-en="Indonesia"
                      data-ja="インドネシア">
              </option>
              <option value="Jepang"
                      data-id="Jepang"
                      data-en="Japan"
                      data-ja="日本">
              </option>
              <option value="Lainnya"
                      data-id="Lainnya"
                      data-en="Other"
                      data-ja="その他">
              </option>
            </select>
          </div>

          <!-- Other Nationality Input -->
          <div class="other-nationality-wrapper" id="otherNationalityWrapper">
            <div class="input-wrapper">
              <i class="fas fa-edit"></i>
              <input type="text"
                     id="kebangsaan_lainnya"
                     name="kebangsaan_lainnya"
                     data-id-ph="Masukkan kebangsaan Anda"
                     data-en-ph="Enter your nationality"
                     data-ja-ph="国籍を入力してください"
                     autocapitalize="words">
            </div>
          </div>
        </div>

        <!-- Age & Gender -->
        <div class="row">
          <div class="field">
            <label data-id="Usia" data-en="Age" data-ja="年齢"></label>
            <div class="input-wrapper">
              <i class="fas fa-birthday-cake"></i>
              <input type="number" id="usia" name="usia" min="1" max="120" required
                     data-id-ph="Usia saat ini"
                     data-en-ph="Current age"
                     data-ja-ph="現在の年齢">
            </div>
          </div>

          <div class="field">
            <label data-id="Jenis Kelamin" data-en="Gender" data-ja="性別"></label>
            <div class="radio-group">
              <input type="radio" id="jk_l" name="jk" value="Laki-laki" required checked>
              <label for="jk_l">
                <i class="fas fa-mars"></i>
                <span data-id="Laki-laki" data-en="Male" data-ja="男性"></span>
              </label>
              <input type="radio" id="jk_p" name="jk" value="Perempuan">
              <label for="jk_p">
                <i class="fas fa-venus"></i>
                <span data-id="Perempuan" data-en="Female" data-ja="女性"></span>
              </label>
            </div>
          </div>
        </div>

        <!-- Attendance Details -->
        <div class="field">
          <label data-id="Detail Kehadiran" data-en="Attendance Details" data-ja="参加者詳細"></label>
          
          <!-- Additional Adults -->
          <div class="field" style="margin-bottom: 1.25rem;">
            <label data-id="Dewasa Tambahan" data-en="Additional Adults" data-ja="追加の大人"></label>
            <div class="input-wrapper">
              <i class="fas fa-user-plus"></i>
              <input type="number" id="dewasa_tambahan" name="dewasa_tambahan" min="0" max="10" value="0"
                     data-id-ph="Jumlah dewasa selain Anda"
                     data-en-ph="Number of adults besides you"
                     data-ja-ph="ご本人以外の大人の人数">
            </div>
            <div class="hint" data-id="Usia 13 tahun ke atas" data-en="Age 13 and above" data-ja="13歳以上"></div>
          </div>

          <!-- Children -->
          <div class="field">
            <label data-id="Datang dengan Anak?" data-en="Coming with Children?" data-ja="お子様と一緒ですか？"></label>
            <div class="toggle-group">
              <input type="radio" id="anak_tidak" name="dengan_anak" value="Tidak" checked>
              <label for="anak_tidak">
                <i class="fas fa-times"></i>
                <span data-id="Tidak" data-en="No" data-ja="いいえ"></span>
              </label>
              <input type="radio" id="anak_ya" name="dengan_anak" value="Ya">
              <label for="anak_ya">
                <i class="fas fa-child"></i>
                <span data-id="Ya" data-en="Yes" data-ja="はい"></span>
              </label>
            </div>
            <div class="hint" data-id="Anak usia 0-12 tahun" data-en="Children age 0-12 years" data-ja="0〜12歳のお子様"></div>
          </div>

          <!-- Number of Children -->
          <div class="children-field-wrapper" id="childrenFieldWrapper">
            <div class="field">
              <label data-id="Jumlah Anak" data-en="Number of Children" data-ja="お子様の人数"></label>
              <div class="input-wrapper">
                <i class="fas fa-baby"></i>
                <input type="number" id="jumlah_anak" name="jumlah_anak" min="1" max="10" value="1">
              </div>
              <div class="hint" data-id="Usia maksimal 12 tahun" data-en="Maximum age: 12 years" data-ja="最大12歳まで"></div>
            </div>
          </div>

          <!-- Total Summary -->
          <div class="total-summary">
            <div class="total-label">
              <i class="fas fa-users"></i>
              <span data-id="Total yang akan hadir" data-en="Total attendees" data-ja="総参加者数"></span>
            </div>
            <div class="total-number" id="totalAttendees">1</div>
            <div class="hint" id="totalDetail" style="color: #4b5563;"></div>
          </div>
          
          <!-- Hidden field for total -->
          <input type="hidden" id="jumlah_orang_total" name="jumlah_orang_total" value="1">
        </div>

        <!-- Consent -->
        <div class="consent">
          <input type="checkbox" id="consentCheckbox" required>
          <span data-id="Saya menyetujui bahwa data ini digunakan untuk keperluan administrasi acara"
                data-en="I agree that this data will be used for event administration purposes"
                data-ja="個人情報がイベントの運営に使用されることに同意します"></span>
        </div>

        <!-- Submit Button -->
        <button type="submit" class="submit-btn" id="submitBtn">
          <span data-id="Daftar Sekarang" data-en="Register Now" data-ja="今すぐ登録"></span>
        </button>
      </form>
    </div>

    <footer>
      <div data-id="© 2026 — Yayasan Ibadurrahman Islamic Center"
           data-en="© 2026 — Ibadurrahman Islamic Center Foundation"
           data-ja="© 2026 — イバドゥッラフマン・イスラムセンター財団"></div>
      <div style="margin-top: 0.5rem; font-size: 0.75rem; color: #9ca3af;">
        <span data-id="Untuk informasi lebih lanjut: info@ibadurrahman.org"
              data-en="For more information: info@ibadurrahman.org"
              data-ja="お問い合わせ: info@ibadurrahman.org"></span>
      </div>
    </footer>
  </div>
</main>

<script>
// Configuration
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwvLVMIbhBThHJ8l3d4Rppo1GvDbgeVjELq8_zOtzD7WHaWIaEHhVqHqyVJpgiaiDzp/exec";

// Detect language
const userLang = navigator.language || navigator.userLanguage;
let lang = 'id';
if (userLang.startsWith('ja')) { 
  lang = 'ja'; 
} else if (userLang.startsWith('en')) { 
  lang = 'en'; 
}

// Application State
let isOTPVerified = false;

// Messages for multilingual
const messages = {
  fillNameEmail: { 
    id: 'Mohon isi nama dan email terlebih dahulu', 
    en: 'Please fill in name and email first', 
    ja: '先に名前とメールアドレスを入力してください' 
  },
  invalidEmail: { 
    id: 'Format email tidak valid', 
    en: 'Invalid email format', 
    ja: 'メールアドレスの形式が無効です' 
  },
  otpSent: { 
    id: 'Kode OTP telah dikirim ke email Anda', 
    en: 'OTP code has been sent to your email', 
    ja: 'OTPコードをメールに送信しました' 
  },
  otpVerified: { 
    id: 'Kode OTP berhasil diverifikasi', 
    en: 'OTP code successfully verified', 
    ja: 'OTPコードが確認されました' 
  },
  invalidOtp: { 
    id: 'Kode OTP tidak valid', 
    en: 'Invalid OTP code', 
    ja: '無効なOTPコードです' 
  },
  verifyOtpFirst: { 
    id: 'Mohon verifikasi kode OTP terlebih dahulu', 
    en: 'Please verify the OTP code first', 
    ja: '先にOTPコードを確認してください' 
  },
  processing: { 
    id: 'Memproses...', 
    en: 'Processing...', 
    ja: '処理中...' 
  },
  sendingOtp: { 
    id: 'Mengirim OTP...', 
    en: 'Sending OTP...', 
    ja: 'OTP送信中...' 
  },
  success: { 
    id: 'Registrasi Berhasil!', 
    en: 'Registration Successful!', 
    ja: '登録が完了しました！' 
  },
  networkError: { 
    id: 'Terjadi kesalahan jaringan.', 
    en: 'Network error.', 
    ja: '通信エラーが発生しました。' 
  },
  selectNationality: {
    id: 'Mohon pilih kebangsaan',
    en: 'Please select nationality',
    ja: '国籍を選択してください'
  },
  fillOtherNationality: {
    id: 'Mohon isi kebangsaan Anda',
    en: 'Please enter your nationality',
    ja: '国籍を入力してください'
  },
  consentRequired: {
    id: 'Harap setujui persetujuan data',
    en: 'Please agree to the data consent',
    ja: 'データ同意に同意してください'
  }
};

// DOM Elements
const registrationForm = document.getElementById('registrationForm');
const namaLengkapInput = document.getElementById('nama_lengkap');
const emailInput = document.getElementById('email');
const sendOtpBtn = document.getElementById('sendOtpBtn');
const otpField = document.getElementById('otpField');
const otpInput = document.getElementById('otp_input');
const otpHint = document.getElementById('otpHint');
const noHpInput = document.getElementById('no_hp');
const kebangsaanSelect = document.getElementById('kebangsaan');
const otherNationalityWrapper = document.getElementById('otherNationalityWrapper');
const kebangsaanLainnyaInput = document.getElementById('kebangsaan_lainnya');
const dewasaTambahanInput = document.getElementById('dewasa_tambahan');
const denganAnakRadio = document.querySelectorAll('input[name="dengan_anak"]');
const childrenFieldWrapper = document.getElementById('childrenFieldWrapper');
const jumlahAnakInput = document.getElementById('jumlah_anak');
const totalAttendeesSpan = document.getElementById('totalAttendees');
const totalDetailSpan = document.getElementById('totalDetail');
const jumlahOrangTotalInput = document.getElementById('jumlah_orang_total');
const consentCheckbox = document.getElementById('consentCheckbox');
const submitBtn = document.getElementById('submitBtn');
const duplicateAlert = document.getElementById('duplicateAlert');

// Initialize multilingual text
function initMultilingual() {
  document.querySelectorAll('[data-id]').forEach(element => {
    const text = element.getAttribute(`data-${lang}`) || element.getAttribute('data-id');
    if (text && element.tagName !== 'INPUT' && element.tagName !== 'TEXTAREA' && element.tagName !== 'SELECT' && element.tagName !== 'OPTION') {
      element.textContent = text;
    }
  });
  
  document.querySelectorAll('[data-id-ph]').forEach(element => {
    const ph = element.getAttribute(`data-${lang}-ph`) || element.getAttribute('data-id-ph');
    if (ph) element.placeholder = ph;
  });
  
  // Update select options
  document.querySelectorAll('option').forEach(option => {
    const translatedText = option.getAttribute(`data-${lang}`) || option.getAttribute('data-id');
    if (translatedText && option.textContent !== '') {
      option.textContent = translatedText;
    }
  });
}

// Calculate total
function calculateTotal() {
  const registrant = 1;
  const additionalAdults = parseInt(dewasaTambahanInput.value) || 0;
  let children = 0;
  
  const denganAnak = document.querySelector('input[name="dengan_anak"]:checked');
  if (denganAnak && denganAnak.value === 'Ya') {
    children = parseInt(jumlahAnakInput.value) || 0;
  }
  
  const total = registrant + additionalAdults + children;
  totalAttendeesSpan.textContent = total;
  jumlahOrangTotalInput.value = total;

  if (lang === 'id') {
    totalDetailSpan.textContent = `${registrant} pendaftar, ${additionalAdults} dewasa, ${children} anak`;
  } else if (lang === 'en') {
    totalDetailSpan.textContent = `${registrant} registrant, ${additionalAdults} adults, ${children} children`;
  } else {
    totalDetailSpan.textContent = `登録者${registrant}名、大人${additionalAdults}名、子供${children}名`;
  }
}

// Send OTP
async function sendOTP() {
  const email = emailInput.value.trim();
  const nama = namaLengkapInput.value.trim();
  
  if (!email || !nama) { 
    alert(messages.fillNameEmail[lang]); 
    return; 
  }
  
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    alert(messages.invalidEmail[lang]);
    return;
  }

  sendOtpBtn.disabled = true;
  const originalBtnText = sendOtpBtn.innerHTML;
  sendOtpBtn.innerHTML = `<span class="loading-spinner"></span> ${messages.sendingOtp[lang]}`;

  try {
    const response = await fetch(`${SCRIPT_URL}?action=send_otp&email=${encodeURIComponent(email)}&nama=${encodeURIComponent(nama)}&lang=${lang}`);
    const result = await response.json();
    
    if (result.status === 'sent') {
      otpField.classList.add('active');
      otpHint.textContent = messages.otpSent[lang];
      otpHint.style.color = '#10a37f';
      
      setTimeout(() => {
        otpInput.focus();
      }, 100);
    }
  } catch (e) { 
    alert(messages.networkError[lang]); 
  } finally { 
    sendOtpBtn.disabled = false; 
    sendOtpBtn.innerHTML = originalBtnText;
    initMultilingual();
  }
}

// Verify OTP
otpInput.addEventListener('input', async () => {
  if (otpInput.value.length === 6) {
    try {
      const response = await fetch(`${SCRIPT_URL}?action=verify_otp&email=${encodeURIComponent(emailInput.value)}&otp=${otpInput.value}`);
      const result = await response.json();
      
      if (result.verified) {
        isOTPVerified = true;
        otpInput.disabled = true;
        otpInput.style.borderColor = '#10a37f';
        otpInput.style.backgroundColor = '#f0fdf4';
        otpHint.textContent = messages.otpVerified[lang];
        otpHint.style.color = '#10a37f';
      } else {
        isOTPVerified = false;
        otpInput.style.borderColor = '#dc2626';
        otpInput.style.backgroundColor = '#fef2f2';
        otpHint.textContent = messages.invalidOtp[lang];
        otpHint.style.color = '#dc2626';
      }
    } catch (e) { 
      console.error('OTP verification error:', e); 
      alert(messages.networkError[lang]);
    }
  } else {
    // Reset hint if OTP is not 6 digits
    const defaultHint = otpHint.getAttribute(`data-${lang}`) || otpHint.getAttribute('data-id');
    otpHint.textContent = defaultHint;
    otpHint.style.color = '';
  }
});

// Check for duplicate registration
let duplicateCheckTimeout;
function checkDuplicate() {
  clearTimeout(duplicateCheckTimeout);
  
  duplicateCheckTimeout = setTimeout(async () => {
    const email = emailInput.value.trim();
    const phone = noHpInput.value.trim();
    
    if (email && phone && phone.length >= 10) {
      try {
        const response = await fetch(`${SCRIPT_URL}?action=check_duplicate&email=${encodeURIComponent(email)}&no_hp=${encodeURIComponent(phone)}`);
        const result = await response.json();
        
        if (result.isDuplicate) {
          duplicateAlert.classList.add('active');
          submitBtn.disabled = true;
        } else {
          duplicateAlert.classList.remove('active');
          submitBtn.disabled = false;
        }
      } catch (error) {
        console.error('Duplicate check error:', error);
      }
    }
  }, 500);
}

// Event Listeners
document.addEventListener('DOMContentLoaded', () => {
  initMultilingual();
  calculateTotal();

  sendOtpBtn.addEventListener('click', sendOTP);
  
  kebangsaanSelect.addEventListener('change', (e) => {
    otherNationalityWrapper.classList.toggle('active', e.target.value === 'Lainnya');
    kebangsaanLainnyaInput.required = e.target.value === 'Lainnya';
    
    if (e.target.value === 'Lainnya') {
      setTimeout(() => kebangsaanLainnyaInput.focus(), 100);
    }
  });

  denganAnakRadio.forEach(r => r.addEventListener('change', () => {
    const denganAnak = document.querySelector('input[name="dengan_anak"]:checked');
    childrenFieldWrapper.classList.toggle('active', denganAnak.value === 'Ya');
    jumlahAnakInput.required = denganAnak.value === 'Ya';
    calculateTotal();
  }));

  dewasaTambahanInput.addEventListener('input', calculateTotal);
  jumlahAnakInput.addEventListener('input', calculateTotal);
  
  // Duplicate check
  emailInput.addEventListener('input', checkDuplicate);
  noHpInput.addEventListener('input', checkDuplicate);

  // Bagian submit yang diperbaiki untuk menghindari isu CORS umum di Apps Script
  registrationForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    if (!isOTPVerified) { 
      alert(messages.verifyOtpFirst[lang]); 
      otpInput.focus();
      return; 
    }
    
    // Validate nationality
    const selectedNationality = kebangsaanSelect.value;
    if (!selectedNationality) {
      alert(messages.selectNationality[lang]);
      kebangsaanSelect.focus();
      return;
    }
    
    // Validate other nationality
    if (selectedNationality === 'Lainnya') {
      const otherNationality = kebangsaanLainnyaInput.value.trim();
      if (!otherNationality) {
        alert(messages.fillOtherNationality[lang]);
        kebangsaanLainnyaInput.focus();
        return;
      }
    }
    
    // Check consent
    if (!consentCheckbox.checked) {
      alert(messages.consentRequired[lang]);
      consentCheckbox.focus();
      return;
    }

    submitBtn.disabled = true;
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = `<span class="loading-spinner"></span> ${messages.processing[lang]}`;

    const formData = new FormData(registrationForm);
    
    // Konversi FormData ke URLSearchParams agar lebih mudah diterima Apps Script
    const params = new URLSearchParams();
    for (const [key, value] of formData) {
      // Logika khusus untuk kebangsaan lainnya
      if (key === 'kebangsaan' && value === 'Lainnya') {
        params.append(key, document.getElementById('kebangsaan_lainnya').value);
      } else if (key !== 'kebangsaan_lainnya') {
        params.append(key, value);
      }
    }
    
    // Tambahkan action dan info bahasa yang digunakan saat mendaftar
    params.append('action', 'register');
    params.append('lang_used', lang);
    
    // Tambahkan OTP untuk verifikasi ulang di server (keamanan tambahan)
    params.append('otp_verification', otpInput.value);

    try {
      // Mengirim data menggunakan metode POST ke SCRIPT_URL
      const response = await fetch(SCRIPT_URL, {
        method: 'POST',
        mode: 'no-cors', // Penting untuk Google Apps Script
        body: params
      });

      // Karena mode: 'no-cors', kita tidak bisa membaca isi JSON respon secara langsung
      // Namun, kita bisa berasumsi jika tidak ada error network, data terkirim
      alert(messages.success[lang]);
      
      // Reset form setelah berhasil
      registrationForm.reset();
      isOTPVerified = false;
      otpField.classList.remove('active');
      otpInput.value = '';
      otpInput.disabled = false;
      otpInput.style.borderColor = '';
      otpInput.style.backgroundColor = '';
      
      // Reset duplicate alert
      duplicateAlert.classList.remove('active');
      submitBtn.disabled = false;
      
      // Reset language text
      initMultilingual();
      calculateTotal();
      
    } catch (error) {
      console.error('Submission error:', error);
      alert(messages.networkError[lang]);
      submitBtn.disabled = false;
      submitBtn.innerHTML = originalText;
      initMultilingual();
    }
  });
});
</script>
</body>
</html>
