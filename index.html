<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Pendaftaran Sholat Idul Fitri - Okayama Central Mosque</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:'Inter',sans-serif;
  background:#f1f5f9;
  color:#1e293b;
}
main{padding:40px 16px}
.container{max-width:480px;margin:auto}

.header{text-align:center;margin-bottom:28px}
.header h1{margin:0;font-size:24px;color:#064e3b;font-weight:700}
.header div{font-size:13px;color:#64748b;margin-top:4px}

.card{
  background:#fff;
  padding:28px;
  border-radius:22px;
  border:1px solid #e2e8f0;
}

.field{margin-bottom:22px}
label{
  display:block;
  margin-bottom:6px;
  font-weight:600;
  font-size:12px;
  color:#475569;
  letter-spacing:.04em;
}

.input-wrapper{position:relative}
.input-wrapper i{
  position:absolute;
  left:16px;
  top:50%;
  transform:translateY(-50%);
  color:#94a3b8;
}

input,select{
  width:100%;
  padding:12px 14px 12px 44px;
  border-radius:14px;
  border:1.5px solid #e2e8f0;
  font-size:14px;
  background:#f8fafc;
}

input:focus,select:focus{
  outline:none;
  border-color:#10b981;
  background:#fff;
}

/* Perbaikan tampilan select di iPad */
select {
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  line-height: 1.4;
  padding-right: 40px;
}

/* Khusus tablet (iPad) */
@media (min-width: 768px) and (max-width: 1024px) {
  select {
    height: 48px;
    font-size: 14px;
  }
}

/* Gender Button Layout - FIXED: radio button visibility */
.gender-group{
  display:flex;
  gap:12px;
  position: relative;
}

.gender-group input{
  position: absolute;
  opacity: 0;
  width: 0;
  height: 0;
}

.gender-group label{
  flex:1;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  padding:12px 14px 12px 44px; /* SAMA dengan input */
  border-radius:14px;
  border:1.5px solid #e2e8f0;
  background:#f8fafc;
  font-size:14px;
  font-weight:500;
  line-height:1;               /* üî• KUNCI PRESISI */
  cursor:pointer;
  transition:.2s ease;
  color:#475569;
}

.gender-group label i{
  font-size:16px;
}

.gender-group input:checked + label{
  background:#ecfdf5;
  border-color:#10b981;
  color:#064e3b;
}

/* iPad / Tablet optimization */
@media (min-width:768px) {
  .gender-group label{
    padding:16px;
    font-size:15px;
  }
}

/* Style OTP Layout */
.otp-container { display: flex; gap: 8px; }
.btn-otp {
  width: auto;
  white-space: nowrap;
  padding: 0 16px;
  font-size: 12px;
  border-radius: 12px;
  background: #064e3b;
  color: #fff;
  border: none;
  cursor: pointer;
}
.btn-otp:disabled { background: #cbd5e1; cursor: not-allowed; }

input[name="domisili"]{
  padding:12px 14px 12px 44px; /* sama dengan input lain */
  font-size:14px;
}

.hint{
  font-size:12px;
  color:#94a3b8;
  margin-top:6px;
}

.row{display:flex;gap:14px}
.row .field{flex:1}

button{
  width:100%;
  padding:16px;
  background:#059669;
  color:#fff;
  border:none;
  border-radius:16px;
  font-weight:600;
  font-size:15px;
  cursor:pointer;
}
button:disabled{background:#cbd5e1;cursor:not-allowed}

.consent{
  display:flex;
  gap:12px;
  padding:14px;
  background:#f0fdf4;
  border:1px solid #dcfce7;
  border-radius:14px;
  font-size:13px;
}
.consent input{
  width:20px;
  height:20px;
  accent-color:#10b981;
}

.alert{
  display:none;
  background:#fff1f2;
  color:#be123c;
  padding:12px;
  border-radius:12px;
  margin-bottom:18px;
  text-align:center;
  font-size:13px;
}

.alert-success {
  background: #f0fdf4;
  color: #065f46;
  border: 1px solid #a7f3d0;
}

.countdown {
  font-size: 11px;
  color: #64748b;
  margin-top: 4px;
  display: block;
}

footer{text-align:center;font-size:12px;color:#94a3b8;padding:28px}

@media(max-width:480px){
  .row{flex-direction:column}
}
</style>
</head>

<body>

<main>
<div class="container">

<div class="alert" id="duplicateAlert"
 data-id="Data ini sudah terdaftar"
 data-en="This data is already registered"
 data-ja="„Åô„Åß„Å´ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åô"></div>

<div class="header">
  <h1 data-id="Pendaftaran Sholat Idul Fitri"
      data-en="Eid Prayer Registration"
      data-ja="ÂèÇÂä†ÁôªÈå≤"></h1>
  <div>Okayama Central Mosque</div>
</div>

<div class="card">
<form id="registrationForm">

<div class="field">
<label data-id="Nama Lengkap" data-en="Full Name" data-ja="Ê∞èÂêç"></label>
<div class="input-wrapper">
<i class="fas fa-user"></i>
<input name="nama_lengkap" id="nama_lengkap" required
 data-id-ph="Nama sesuai identitas"
 data-en-ph="Name as shown on ID"
 data-ja-ph="Ë∫´ÂàÜË®ºÈÄö„Çä„ÅÆÊ∞èÂêç">
</div>
</div>

<div class="field">
<label>Email</label>
<div class="otp-container">
  <div class="input-wrapper" style="flex:1">
    <i class="fas fa-envelope"></i>
    <input type="email" name="email" id="email" required placeholder="contoh@email.com">
  </div>
  <button type="button" class="btn-otp" id="sendOtpBtn" onclick="sendOTP()">
    <span data-id="Kirim Kode" data-en="Send Code" data-ja="„Ç≥„Éº„ÉâÈÄÅ‰ø°"></span>
  </button>
</div>
<div class="hint"
 data-id="Email ini digunakan untuk konfirmasi pendaftaran"
 data-en="This email will be used for registration confirmation"
 data-ja="Á¢∫Ë™ç„ÅÆ„Åü„ÇÅ„Å´‰ΩøÁî®„Åï„Çå„Åæ„Åô"></div>
</div>

<div class="field" id="otpField" style="display:none; background:#f0fdf4; padding:15px; border-radius:14px; border:1px dashed #10b981">
<label data-id="Masukkan Kode OTP" data-en="Enter OTP Code" data-ja="OTP„Ç≥„Éº„Éâ„ÇíÂÖ•Âäõ"></label>
<div class="input-wrapper">
<i class="fas fa-key"></i>
<input type="number" inputmode="numeric" pattern="[0-9]{4}" id="otp_input" maxlength="4" placeholder="1234" oninput="this.value = this.value.slice(0, 4).replace(/[^0-9]/g, '')">
</div>
<input type="hidden" id="otp_token" name="otp_token">
<span class="countdown" id="otpCountdown" style="display:none;"></span>
</div>

<div class="field">
<label data-id="Nomor HP" data-en="Phone Number" data-ja="ÈõªË©±Áï™Âè∑"></label>
<div class="input-wrapper">
<i class="fas fa-phone"></i>
<input type="tel" name="no_hp" id="no_hp" required placeholder="08012345678">
</div>
<div class="hint"
 data-id="Gunakan nomor yang bisa dihubungi"
 data-en="Use an active phone number"
 data-ja="ÈÄ£Áµ°ÂèØËÉΩ„Å™Áï™Âè∑„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ"></div>
</div>

<div class="field">
<label data-id="Domisili" data-en="City / Residence" data-ja="Â±Ö‰ΩèÂú∞"></label>
<div class="input-wrapper">
<i class="fas fa-map-marker-alt"></i>
<input name="domisili" list="neighborhoods" required
 data-id-ph="Cari kelurahan (Contoh: Kaminakano)"
 data-en-ph="Search neighborhood (Ex: Kaminakano)"
 data-ja-ph="Áî∫Âêç„ÇíÊ§úÁ¥¢ (‰æãÔºö‰∏ä‰∏≠Èáé)">
<datalist id="neighborhoods">
  <option value="Okayama-shi, Kita-ku, Kaminakano">
  <option value="Okayama-shi, Kita-ku, Ima">
  <option value="Okayama-shi, Kita-ku, Omoto">
  <option value="Okayama-shi, Kita-ku, Tsushima">
  <option value="Okayama-shi, Kita-ku, Hokan-cho">
  <option value="Okayama-shi, Naka-ku, Nishigawara">
  <option value="Okayama-shi, Minami-ku, Toyonari">
  
  <option value="Kurashiki-shi, Achi">
  <option value="Kurashiki-shi, Nakasho">
  <option value="Kurashiki-shi, Chaya-machi">
  <option value="Kurashiki-shi, Mizushima">
  <option value="Kurashiki-shi, Kojima">
  <option value="Kurashiki-shi, Tamashima">

  <option value="Tamano-shi, Chikko">
  <option value="Tamano-shi, Uno">
  <option value="Tamano-shi, Hibibi">
  <option value="Tamano-shi, Shibukawa">

  <option value="Soja-shi, Chuo">
  <option value="Soja-shi, Kiyone">
  <option value="Soja-shi, Yamate">

  <option value="Akaiwa-shi, Sanyo">
  <option value="Setouchi-shi, Oku-cho">
</datalist>
</div>
</div>

<div class="row">
<div class="field">
<label data-id="Usia" data-en="Age" data-ja="Âπ¥ÈΩ¢"></label>
<div class="input-wrapper">
<i class="fas fa-id-card"></i>
<input type="number" name="usia" min="1" max="120" required>
</div>
</div>

<div class="field">
<label data-id="Jumlah Orang" data-en="Number of People" data-ja="‰∫∫Êï∞"></label>
<div class="input-wrapper">
<i class="fas fa-users"></i>
<input type="number" name="jumlah_orang" min="1" value="1" required>
</div>
<div class="hint"
 data-id="Jumlah orang yang hadir, termasuk Anda"
 data-en="Total number of attendees, including you"
 data-ja="„ÅîÊú¨‰∫∫„ÇíÂê´„ÇÄ‰∫∫Êï∞"></div>
</div>
</div>

<div class="field">
<label data-id="Jenis Kelamin" data-en="Gender" data-ja="ÊÄßÂà•"></label>

<div class="gender-group">
  <input type="radio" id="jk_l" name="jk" value="Laki-laki" required>
  <label for="jk_l">
    <i class="fas fa-mars"></i>
    <span data-id="Laki-laki" data-en="Male" data-ja="Áî∑ÊÄß"></span>
  </label>

  <input type="radio" id="jk_p" name="jk" value="Perempuan">
  <label for="jk_p">
    <i class="fas fa-venus"></i>
    <span data-id="Perempuan" data-en="Female" data-ja="Â•≥ÊÄß"></span>
  </label>
</div>
</div>

<div class="field">
<label class="consent">
<input type="checkbox" required>
<span data-id="Saya menyetujui data digunakan untuk keperluan acara ini"
      data-en="I agree that my data will be used for this event"
      data-ja="Êú¨„Ç§„Éô„É≥„Éà„ÅÆ„Åü„ÇÅ„Å´ÂÄã‰∫∫ÊÉÖÂ†±„Çí‰ΩøÁî®„Åô„Çã„Åì„Å®„Å´ÂêåÊÑè„Åó„Åæ„Åô"></span>
</label>
</div>

<button type="submit" id="submitBtn"
 data-id="Daftar"
 data-en="Register"
 data-ja="ÁôªÈå≤"></button>

</form>
</div>
</div>
</main>

<footer>¬© 2026 ‚Äî Masjid Central Okayama</footer>

<script>
const SCRIPT_URL="https://script.google.com/macros/s/AKfycbzizsTk_rqB5dQ2vBp7196Xmhk89-nJq3DMgoSf5EUck9XUbbbHtajlCehEEbHQgRog/exec";

const lang=navigator.language.startsWith("ja")?"ja":
           navigator.language.startsWith("en")?"en":"id";

document.querySelectorAll("[data-id]").forEach(el=>{
 el.textContent=el.dataset[lang]||el.dataset.id;
});
document.querySelectorAll("[data-id-ph]").forEach(el=>{
 el.placeholder=el.dataset[`${lang}Ph`]||el.dataset.idPh;
});

// Deklarasi variabel yang diperlukan
const sendOtpBtn = document.getElementById("sendOtpBtn");
const email = document.getElementById("email");
const no_hp = document.getElementById("no_hp");
const duplicateAlert = document.getElementById("duplicateAlert");
const registrationForm = document.getElementById("registrationForm");
const submitBtn = document.getElementById("submitBtn");
const otpField = document.getElementById("otpField");
const otpInput = document.getElementById("otp_input");
const otpToken = document.getElementById("otp_token");
const otpCountdown = document.getElementById("otpCountdown");

let otpTimer = null;
let otpExpiry = null;

const messages = {
  fillEmail: {
    id: "Mohon isi Nama dan Email dulu",
    en: "Please fill in Name and Email first",
    ja: "ÂÖà„Å´ÂêçÂâç„Å®„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ"
  },
  verifyOtp: {
    id: "Mohon verifikasi kode OTP dulu",
    en: "Please verify the OTP code first",
    ja: "ÂÖà„Å´OTP„Ç≥„Éº„Éâ„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ"
  },
  otpSent: {
    id: "OTP terkirim ke email!",
    en: "OTP sent to your email!",
    ja: "OTP„Åå„É°„Éº„É´„Å´ÈÄÅ‰ø°„Åï„Çå„Åæ„Åó„ÅüÔºÅ"
  },
  otpExpired: {
    id: "Kode OTP sudah kadaluarsa",
    en: "OTP code has expired",
    ja: "OTP„Ç≥„Éº„Éâ„ÅÆÊúâÂäπÊúüÈôê„ÅåÂàá„Çå„Å¶„ÅÑ„Åæ„Åô"
  },
  otpResend: {
    id: "Kirim Ulang Kode",
    en: "Resend Code",
    ja: "„Ç≥„Éº„Éâ„ÇíÂÜçÈÄÅ"
  }
};

// Reset OTP status saat email berubah
email.addEventListener('input', () => {
  resetOTP();
});

async function sendOTP() {
  const emailVal = email.value;
  const namaVal = document.getElementById("nama_lengkap").value;
  
  if(!emailVal || !namaVal) {
    alert(messages.fillEmail[lang]);
    return;
  }

  const originalText = sendOtpBtn.innerHTML;
  sendOtpBtn.disabled = true;
  sendOtpBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

  try {
    const r = await fetch(`${SCRIPT_URL}?action=send_otp&email=${encodeURIComponent(emailVal)}&nama=${encodeURIComponent(namaVal)}`);
    const j = await r.json();
    
    if(j.status === "success") {
      // Simpan token OTP (bukan kode)
      otpToken.value = j.token || "";
      
      // Tampilkan field OTP
      otpField.style.display = "block";
      otpInput.value = "";
      otpInput.disabled = false;
      otpInput.focus();
      
      // Set waktu kadaluarsa (5 menit)
      otpExpiry = Date.now() + 5 * 60 * 1000;
      
      // Tampilkan countdown
      otpCountdown.style.display = "block";
      startCountdown();
      
      // Tampilkan pesan sukses
      showAlert(messages.otpSent[lang], "success");
      
      // Reset tombol setelah 2 detik
      setTimeout(() => {
        sendOtpBtn.disabled = false;
        sendOtpBtn.innerHTML = `<span>${messages.otpResend[lang]}</span>`;
      }, 2000);
    } else {
      alert(j.message || "Error");
      sendOtpBtn.disabled = false;
      sendOtpBtn.innerHTML = originalText;
    }
  } catch(e) {
    console.error("OTP Error:", e);
    alert("Terjadi kesalahan. Coba lagi.");
    sendOtpBtn.disabled = false;
    sendOtpBtn.innerHTML = originalText;
  }
}

function startCountdown() {
  if (otpTimer) clearInterval(otpTimer);
  
  otpTimer = setInterval(() => {
    const now = Date.now();
    const remaining = Math.max(0, otpExpiry - now);
    
    if (remaining <= 0) {
      clearInterval(otpTimer);
      otpCountdown.textContent = lang === 'id' ? "Kode OTP telah kadaluarsa" : 
                                 lang === 'en' ? "OTP code has expired" : 
                                 "OTP„Ç≥„Éº„Éâ„ÅÆÊúâÂäπÊúüÈôê„ÅåÂàá„Çå„Å¶„ÅÑ„Åæ„Åô";
      otpInput.disabled = true;
      return;
    }
    
    const minutes = Math.floor(remaining / 60000);
    const seconds = Math.floor((remaining % 60000) / 1000);
    
    otpCountdown.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
  }, 1000);
}

function resetOTP() {
  otpField.style.display = "none";
  otpToken.value = "";
  otpInput.value = "";
  if (otpTimer) {
    clearInterval(otpTimer);
    otpTimer = null;
  }
  otpCountdown.style.display = "none";
  otpCountdown.textContent = "";
  
  // Reset tombol OTP
  sendOtpBtn.disabled = false;
  sendOtpBtn.innerHTML = `<span data-id="Kirim Kode" data-en="Send Code" data-ja="„Ç≥„Éº„ÉâÈÄÅ‰ø°">${messages.otpResend[lang]}</span>`;
}

function showAlert(message, type = "error") {
  const alertDiv = document.createElement('div');
  alertDiv.className = `alert ${type === 'success' ? 'alert-success' : ''}`;
  alertDiv.textContent = message;
  alertDiv.style.display = 'block';
  
  const container = document.querySelector('.container');
  container.insertBefore(alertDiv, container.firstChild);
  
  setTimeout(() => {
    alertDiv.remove();
  }, 5000);
}

// Check duplicate dengan encode
let checkDuplicateTimer;
email.oninput = no_hp.oninput = () => {
  clearTimeout(checkDuplicateTimer);
  checkDuplicateTimer = setTimeout(async () => {
    if(email.value && no_hp.value){
      try {
        const r = await fetch(`${SCRIPT_URL}?action=check_duplicate&email=${encodeURIComponent(email.value)}&no_hp=${encodeURIComponent(no_hp.value)}`);
        const j = await r.json();
        duplicateAlert.style.display = j.isDuplicate ? "block" : "none";
        submitBtn.disabled = j.isDuplicate;
        
        if (j.isDuplicate) {
          resetOTP();
        }
      } catch (error) {
        console.error("Check duplicate error:", error);
        // Tidak tampilkan error ke user untuk UX yang lebih baik
      }
    }
  }, 800);
};

registrationForm.onsubmit = async e => {
  e.preventDefault();
  
  // Validasi OTP wajib diisi
  if (!otpToken.value || !otpInput.value) {
    alert(messages.verifyOtp[lang]);
    return;
  }
  
  // Validasi OTP masih berlaku
  if (otpExpiry && Date.now() > otpExpiry) {
    alert(messages.otpExpired[lang]);
    return;
  }
  
  submitBtn.disabled = true;
  const processingText = {id:"Sedang memproses‚Ä¶",en:"Processing‚Ä¶",ja:"Âá¶ÁêÜ‰∏≠‚Ä¶"};
  const original = submitBtn.textContent;
  submitBtn.textContent = processingText[lang];

  const fd = new FormData(registrationForm);
  fd.append("action", "register");
  fd.append("otp_code", otpInput.value);

  // Membuat ID Cantik: EID-2703-X8A9 (TanggalBulan-Acak 4 digit)
  const now = new Date();
  const datePart = ("0" + now.getDate()).slice(-2) + ("0" + (now.getMonth() + 1)).slice(-2);
  const randomPart = Math.random().toString(36).substring(2, 6).toUpperCase();
  const cantikID = "EID-" + datePart + "-" + randomPart;

  fd.append("id", cantikID);
  fd.append("lang", lang);
  
  try {
    const r = await fetch(SCRIPT_URL, {method: "POST", body: fd});
    const j = await r.json();
    
    if(j.status === "success") {
      window.location.href = "success.html?" + new URLSearchParams(fd).toString();
    } else {
      // Jika OTP invalid, reset OTP
      if (j.message && j.message.toLowerCase().includes('otp')) {
        resetOTP();
      }
      alert(j.message || "Error");
      submitBtn.textContent = original;
      submitBtn.disabled = false;
    }
  } catch {
    alert(lang === 'id' ? "Koneksi bermasalah" : 
          lang === 'en' ? "Connection problem" : 
          "Êé•Á∂ö„Å´ÂïèÈ°å„Åå„ÅÇ„Çä„Åæ„Åô");
    submitBtn.textContent = original;
    submitBtn.disabled = false;
  }
};
</script>

</body>
</html>
