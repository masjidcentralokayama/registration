<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Konfirmasi Registrasi - Buka Puasa Bersama 1447 H</title>
    
    <!-- CSS dan JavaScript akan disisipkan inline untuk performance -->
    <style>
        /* Semua style tetap sama seperti sebelumnya */
        :root {
            --accent-green: #10a37f;
            --accent-green-dark: #0d8465;
            --accent-gold: #d4af37;
            --accent-gold-light: #f0e6c5;
            --accent-teal: #0f766e;
            --accent-dark: #1e293b;
            --accent-light: #f8fafc;
            --error-red: #dc2626;
            --success-green: #059669;
            --warning-orange: #f59e0b;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f7f7f8 0%, #f0f9ff 100%);
            min-height: 100vh;
            padding: 1rem;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 2px solid var(--accent-gold);
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--accent-gold-light);
        }

        .success-icon {
            width: 80px;
            height: 80px;
            background: var(--accent-green);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 2.5rem;
        }

        .card {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--accent-gold);
        }

        .qr-container {
            text-align: center;
            padding: 1rem;
            background: white;
            border-radius: 10px;
            margin: 1rem 0;
        }

        #qrcode {
            display: inline-block;
            padding: 10px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
        }

        .data-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .data-label {
            color: var(--accent-teal);
            font-weight: 600;
        }

        .data-value {
            font-weight: 600;
            color: var(--accent-dark);
            text-align: right;
        }

        .error-box {
            background: #fee2e2;
            color: #991b1b;
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
            text-align: center;
            border: 1px solid #fca5a5;
        }

        .warning-box {
            background: #fef3c7;
            color: #92400e;
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
            text-align: center;
            border: 1px solid #fcd34d;
        }

        .info-box {
            background: #ecfdf5;
            color: #065f46;
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
            text-align: center;
            border: 1px solid #a7f3d0;
        }

        .buttons {
            display: flex;
            gap: 10px;
            margin-top: 2rem;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--accent-green);
            color: white;
        }

        .btn-secondary {
            background: white;
            color: var(--accent-teal);
            border: 2px solid var(--accent-teal);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f1f5f9;
            border-top: 4px solid var(--accent-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #debugInfo {
            margin-top: 1rem;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 10px;
            font-size: 12px;
            color: #64748b;
            display: none;
        }

        #debugInfo.active {
            display: block;
        }

        .id-verification {
            background: linear-gradient(135deg, #a7f3d0 0%, #6ee7b7 100%);
            color: #065f46;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            margin-top: 10px;
            display: inline-block;
            font-size: 1.1rem;
        }

        .id-mismatch {
            background: linear-gradient(135deg, #fca5a5 0%, #f87171 100%);
            color: #7f1d1d;
        }
    </style>
</head>
<body>
    <div class="loading active" id="loading">
        <div class="spinner"></div>
        <p>Memverifikasi registrasi...</p>
    </div>

    <div class="container" id="mainContent" style="display: none;">
        <!-- Header -->
        <div class="header">
            <div class="success-icon">‚úì</div>
            <h1>Pendaftaran Berhasil!</h1>
            <p>Data Anda telah tersimpan dalam sistem</p>
        </div>

        <!-- Error Message -->
        <div class="error-box" id="errorBox" style="display: none;"></div>

        <!-- Warning Message -->
        <div class="warning-box" id="warningBox" style="display: none;"></div>

        <!-- Success Card -->
        <div class="card">
            <div style="text-align: center; margin-bottom: 1rem;">
                <h2 style="color: var(--accent-teal);">Buka Puasa Bersama 1447 H</h2>
                <p style="color: var(--accent-gold); font-weight: 600;">Masjid Central Okayama</p>
            </div>

            <!-- ID Display -->
            <div style="text-align: center; margin: 1rem 0;">
                <div class="id-verification" id="idDisplay">
                    <span id="idValue">Loading...</span>
                    <span id="idStatus" style="margin-left: 8px; font-size: 0.8rem;">üîç</span>
                </div>
                <div style="font-size: 0.9rem; color: #64748b; margin-top: 5px;">
                    <span id="idSource">Sumber: URL Parameter</span>
                </div>
            </div>

            <!-- QR Code -->
            <div class="qr-container">
                <h3 style="color: var(--accent-teal); margin-bottom: 1rem;">Kode QR Check-in</h3>
                <div id="qrcode"></div>
                <div style="margin-top: 1rem; font-size: 0.9rem; color: #64748b;">
                    <p>üì± Tunjukkan QR Code ini saat check-in</p>
                </div>
            </div>

            <!-- Data Peserta -->
            <div style="margin-top: 1.5rem;">
                <h3 style="color: var(--accent-teal); margin-bottom: 1rem;">Data Peserta</h3>
                <div id="participantData">
                    <!-- Data akan dimuat di sini -->
                </div>
            </div>

            <!-- Important Info -->
            <div class="info-box">
                <p>üí° <strong>Simpan halaman ini!</strong> QR Code ini adalah tiket digital Anda.</p>
                <p style="margin-top: 5px; font-size: 0.9rem;">Tunjukkan QR Code kepada petugas saat kedatangan</p>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="buttons">
            <button class="btn btn-primary" id="downloadBtn">
                üíæ Simpan Kartu
            </button>
            <a href="index.html" class="btn btn-secondary">
                üè† Kembali
            </a>
        </div>

        <!-- Debug Info (akan disembunyikan di production) -->
        <div id="debugInfo">
            <h4>Debug Information</h4>
            <div id="debugContent"></div>
            <button onclick="toggleDebug()" style="margin-top: 10px; padding: 5px 10px; background: #64748b; color: white; border: none; border-radius: 5px; font-size: 10px;">
                Toggle Debug
            </button>
        </div>
    </div>

    <script>
        // ============================================
        // Aplikasi Registrasi Iftar - SOLUSI ID PROBLEM
        // ============================================

        // Global variables
        let registrationData = null;
        let qrCodeImage = null;
        let isDownloading = false;
        let DEBUG_MODE = false;

        // ============================================
        // FUNGSI UTAMA
        // ============================================

        /**
         * Inisialisasi aplikasi
         */
        async function initializeApp() {
            try {
                console.log('Initializing Iftar Registration App...');
                
                // 1. Ambil semua parameter URL
                const urlParams = getAllUrlParameters();
                console.log('URL Parameters:', urlParams);
                
                // 2. Cek jika ada error dari Google Apps Script
                if (urlParams.error) {
                    showError('Terjadi kesalahan pada server: ' + decodeURIComponent(urlParams.error));
                    hideLoading();
                    return;
                }
                
                // 3. Coba multiple strategies untuk mendapatkan ID
                const idStrategies = [
                    // Priority 1: Direct ID dari Google Apps Script response
                    () => urlParams.generatedId || urlParams.sheetId || urlParams.rowId,
                    
                    // Priority 2: ID dari form submission
                    () => urlParams.id || urlParams.ID || urlParams.registrationId,
                    
                    // Priority 3: Ambil dari hash
                    () => {
                        const hash = window.location.hash.substring(1);
                        return hash || null;
                    },
                    
                    // Priority 4: Generate dari timestamp
                    () => {
                        return generateFallbackId();
                    }
                ];
                
                let registrationId = null;
                for (const strategy of idStrategies) {
                    const result = strategy();
                    if (result) {
                        registrationId = result.toString().trim().toUpperCase();
                        console.log(`Found ID using strategy: ${strategy.name} -> ${registrationId}`);
                        break;
                    }
                }
                
                if (!registrationId) {
                    showError('Tidak dapat menemukan ID registrasi. Silakan hubungi panitia.');
                    hideLoading();
                    return;
                }
                
                // 4. Coba verifikasi dengan Google Sheet
                let verifiedData = await verifyWithGoogleSheet(registrationId, urlParams);
                
                if (!verifiedData) {
                    // Jika verifikasi gagal, gunakan data dari URL
                    verifiedData = createRegistrationDataFromUrl(registrationId, urlParams);
                    showWarning('ID tidak ditemukan di database. Menggunakan data dari URL.');
                }
                
                // 5. Tampilkan data
                registrationData = verifiedData;
                displayRegistrationData(verifiedData);
                
                // 6. Setup event listeners
                setupEventListeners();
                
                // 7. Sembunyikan loading
                hideLoading();
                document.getElementById('mainContent').style.display = 'block';
                
                // 8. Update debug info
                updateDebugInfo(verifiedData, urlParams);
                
            } catch (error) {
                console.error('App initialization error:', error);
                showError('Terjadi kesalahan sistem. Silakan refresh halaman.');
                hideLoading();
            }
        }

        /**
         * Ambil semua parameter URL
         */
        function getAllUrlParameters() {
            const params = new URLSearchParams(window.location.search);
            const result = {};
            
            // Tambahkan semua parameter
            for (const [key, value] of params.entries()) {
                result[key] = decodeURIComponent(value);
            }
            
            // Cek juga hash parameters
            const hash = window.location.hash.substring(1);
            if (hash) {
                try {
                    const hashParams = new URLSearchParams(hash);
                    for (const [key, value] of hashParams.entries()) {
                        if (!result[key]) {
                            result[key] = decodeURIComponent(value);
                        }
                    }
                } catch (e) {
                    console.log('Cannot parse hash as URLSearchParams');
                }
            }
            
            return result;
        }

        /**
         * Verifikasi ID dengan Google Sheet menggunakan Apps Script Web App
         */
        async function verifyWithGoogleSheet(registrationId, urlParams) {
            try {
                // URL Google Apps Script Web App untuk verifikasi
                const scriptUrl = 'https://script.google.com/macros/s/AKfycbwYv4eO7gOQn7T4W8L8e2XvQ8WJ4p9Q7L6K5d4X3Z/exec';
                
                const response = await fetch(scriptUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        action: 'verify',
                        id: registrationId,
                        nama: urlParams.nama || '',
                        email: urlParams.email || '',
                        timestamp: new Date().toISOString()
                    })
                });
                
                if (!response.ok) {
                    console.warn('Google Sheet verification failed:', response.status);
                    return null;
                }
                
                const data = await response.json();
                
                if (data.success && data.registration) {
                    console.log('‚úÖ ID verified with Google Sheet:', data.registration.id);
                    return {
                        id: data.registration.id,
                        nama: data.registration.nama || urlParams.nama || 'Jamaah',
                        email: data.registration.email || urlParams.email || '-',
                        phone: data.registration.phone || urlParams.phone || '-',
                        domisili: data.registration.domisili || urlParams.domisili || '-',
                        qty: data.registration.qty || urlParams.qty || '1',
                        verified: true,
                        source: 'google_sheet',
                        rowNumber: data.registration.rowNumber
                    };
                } else {
                    console.log('‚ùå ID not found in Google Sheet:', registrationId);
                    return null;
                }
                
            } catch (error) {
                console.warn('Google Sheet verification error:', error);
                return null;
            }
        }

        /**
         * Buat data registrasi dari URL parameters
         */
        function createRegistrationDataFromUrl(registrationId, urlParams) {
            return {
                id: registrationId,
                nama: urlParams.nama || 'Jamaah',
                email: urlParams.email || '-',
                phone: urlParams.phone || '-',
                domisili: urlParams.domisili || '-',
                qty: urlParams.qty || '1',
                verified: false,
                source: 'url_parameters'
            };
        }

        /**
         * Generate fallback ID
         */
        function generateFallbackId() {
            const now = new Date();
            const dateStr = now.toISOString().slice(0,10).replace(/-/g, '');
            const timeStr = now.getTime().toString().slice(-6);
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `IFTAR-FB-${dateStr}-${timeStr}-${random}`;
        }

        /**
         * Tampilkan data registrasi
         */
        function displayRegistrationData(data) {
            // Update ID display
            const idDisplay = document.getElementById('idDisplay');
            const idValue = document.getElementById('idValue');
            const idStatus = document.getElementById('idStatus');
            const idSource = document.getElementById('idSource');
            
            idValue.textContent = data.id;
            
            if (data.verified) {
                idDisplay.classList.add('id-verification');
                idDisplay.classList.remove('id-mismatch');
                idStatus.textContent = '‚úÖ';
                idStatus.title = 'ID diverifikasi dengan Google Sheet';
                idSource.textContent = `Sumber: Google Sheet (Row ${data.rowNumber})`;
            } else {
                idDisplay.classList.remove('id-verification');
                idDisplay.classList.add('id-mismatch');
                idStatus.textContent = '‚ö†Ô∏è';
                idStatus.title = 'ID tidak diverifikasi dengan Google Sheet';
                idSource.textContent = 'Sumber: Parameter URL';
            }
            
            // Tampilkan data peserta
            const participantData = document.getElementById('participantData');
            participantData.innerHTML = `
                <div class="data-row">
                    <span class="data-label">Nama Lengkap:</span>
                    <span class="data-value">${data.nama}</span>
                </div>
                <div class="data-row">
                    <span class="data-label">Email:</span>
                    <span class="data-value">${data.email}</span>
                </div>
                <div class="data-row">
                    <span class="data-label">Telepon:</span>
                    <span class="data-value">${data.phone}</span>
                </div>
                <div class="data-row">
                    <span class="data-label">Domisili:</span>
                    <span class="data-value">${data.domisili}</span>
                </div>
                <div class="data-row">
                    <span class="data-label">Jumlah Orang:</span>
                    <span class="data-value">${data.qty} Orang</span>
                </div>
                <div class="data-row">
                    <span class="data-label">Tanggal Acara:</span>
                    <span class="data-value">Sabtu, 28 Maret 2026</span>
                </div>
                <div class="data-row">
                    <span class="data-label">Waktu:</span>
                    <span class="data-value">17.30 - 20.00 WIB</span>
                </div>
                <div class="data-row">
                    <span class="data-label">Lokasi:</span>
                    <span class="data-value">Masjid Central Okayama</span>
                </div>
            `;
            
            // Generate QR Code
            generateQRCode(data.id);
        }

        /**
         * Generate QR Code sederhana tanpa library
         */
        function generateQRCode(id) {
            const qrcodeElement = document.getElementById('qrcode');
            
            // Fallback jika tidak ada library
            if (typeof QRCode === 'undefined') {
                qrcodeElement.innerHTML = `
                    <div style="padding: 20px; text-align: center;">
                        <div style="font-size: 1.5rem; color: #0f766e; margin-bottom: 10px;">
                            <i class="fas fa-id-card-alt"></i>
                        </div>
                        <div style="font-size: 1.2rem; font-weight: bold; color: #1e293b; margin: 10px 0; word-break: break-all;">
                            ${id}
                        </div>
                        <div style="color: #64748b; font-size: 0.9rem;">
                            <i class="fas fa-exclamation-triangle"></i> Scan manual
                        </div>
                    </div>
                `;
                return;
            }
            
            // Gunakan library jika ada
            try {
                qrcodeElement.innerHTML = '';
                new QRCode(qrcodeElement, {
                    text: id,
                    width: 200,
                    height: 200,
                    colorDark: "#0a5c5a",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
                
                // Simpan QR code image
                setTimeout(() => {
                    const canvas = qrcodeElement.querySelector('canvas');
                    if (canvas) {
                        qrCodeImage = canvas.toDataURL('image/png');
                    }
                }, 500);
                
            } catch (error) {
                console.error('QR Code generation error:', error);
                // Fallback
                qrcodeElement.innerHTML = `
                    <div style="padding: 20px; background: white; border-radius: 10px;">
                        <div style="font-weight: bold; color: #0a5c5a; font-size: 1.2rem; margin-bottom: 10px;">
                            ${id}
                        </div>
                        <div style="color: #64748b; font-size: 0.9rem;">
                            Barcode untuk check-in
                        </div>
                    </div>
                `;
            }
        }

        /**
         * Download kartu sebagai gambar
         */
        async function downloadCard() {
            if (isDownloading || !registrationData) return;
            
            isDownloading = true;
            const btn = document.getElementById('downloadBtn');
            const originalText = btn.innerHTML;
            
            btn.innerHTML = '‚è≥ Mengunduh...';
            btn.disabled = true;
            
            try {
                // Cek jika html2canvas tersedia
                if (typeof html2canvas === 'undefined') {
                    // Fallback: download sebagai text file dengan ID
                    const blob = new Blob([`KARTU IFTAR 1447 H\nID: ${registrationData.id}\nNama: ${registrationData.nama}\nEmail: ${registrationData.email}\nTelepon: ${registrationData.phone}\nDomisili: ${registrationData.domisili}\nJumlah: ${registrationData.qty} Orang\n\nTunjukkan ID ini saat check-in.`], 
                        {type: 'text/plain'});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `KARTU_IFTAR_${registrationData.id}.txt`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    showSuccessMessage('Kartu berhasil diunduh sebagai file teks');
                } else {
                    // Gunakan html2canvas jika tersedia
                    const cardElement = document.querySelector('.card');
                    const canvas = await html2canvas(cardElement, {
                        scale: 2,
                        backgroundColor: null,
                        logging: false
                    });
                    
                    const link = document.createElement('a');
                    link.href = canvas.toDataURL('image/png');
                    link.download = `KARTU_IFTAR_${registrationData.id}.png`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    showSuccessMessage('Kartu berhasil diunduh sebagai gambar');
                }
                
            } catch (error) {
                console.error('Download error:', error);
                showWarning('Gagal mengunduh kartu. Silakan screenshot halaman ini.');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
                isDownloading = false;
            }
        }

        /**
         * Setup event listeners
         */
        function setupEventListeners() {
            // Download button
            document.getElementById('downloadBtn').addEventListener('click', downloadCard);
            
            // Double tap logo untuk debug mode
            document.querySelector('.success-icon').addEventListener('dblclick', () => {
                DEBUG_MODE = !DEBUG_MODE;
                document.getElementById('debugInfo').classList.toggle('active', DEBUG_MODE);
                console.log('Debug mode:', DEBUG_MODE ? 'ON' : 'OFF');
            });
            
            // Keyboard shortcut untuk debug: Ctrl+Shift+D
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                    DEBUG_MODE = !DEBUG_MODE;
                    document.getElementById('debugInfo').classList.toggle('active', DEBUG_MODE);
                    console.log('Debug mode:', DEBUG_MODE ? 'ON' : 'OFF');
                    e.preventDefault();
                }
            });
        }

        /**
         * Update debug information
         */
        function updateDebugInfo(data, urlParams) {
            const debugContent = document.getElementById('debugContent');
            if (!debugContent) return;
            
            debugContent.innerHTML = `
                <p><strong>ID Data:</strong> ${data.id}</p>
                <p><strong>Source:</strong> ${data.source}</p>
                <p><strong>Verified:</strong> ${data.verified ? '‚úÖ Yes' : '‚ùå No'}</p>
                <p><strong>URL Parameters:</strong></p>
                <pre style="background: #f1f5f9; padding: 10px; border-radius: 5px; font-size: 10px; max-height: 200px; overflow: auto;">${JSON.stringify(urlParams, null, 2)}</pre>
                <p><strong>Current URL:</strong></p>
                <pre style="background: #f1f5f9; padding: 10px; border-radius: 5px; font-size: 10px; overflow: auto; word-break: break-all;">${window.location.href}</pre>
            `;
        }

        /**
         * Toggle debug display
         */
        function toggleDebug() {
            const debugInfo = document.getElementById('debugInfo');
            DEBUG_MODE = !debugInfo.classList.contains('active');
            debugInfo.classList.toggle('active', DEBUG_MODE);
        }

        /**
         * UI Helper functions
         */
        function showError(message) {
            const errorBox = document.getElementById('errorBox');
            errorBox.textContent = message;
            errorBox.style.display = 'block';
        }

        function showWarning(message) {
            const warningBox = document.getElementById('warningBox');
            warningBox.textContent = message;
            warningBox.style.display = 'block';
            
            // Auto hide setelah 5 detik
            setTimeout(() => {
                warningBox.style.display = 'none';
            }, 5000);
        }

        function showSuccessMessage(message) {
            // Buat toast notification
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: var(--accent-green);
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                z-index: 1000;
                animation: slideIn 0.3s ease;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }

        function hideLoading() {
            document.getElementById('loading').classList.remove('active');
        }

        // ============================================
        // LOAD EXTERNAL LIBRARIES
        // ============================================

        /**
         * Load QRCode library dynamically
         */
        function loadQRCodeLibrary() {
            return new Promise((resolve, reject) => {
                if (typeof QRCode !== 'undefined') {
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js';
                script.integrity = 'sha512-CNgIRecGo7nphbeZ04Sc13ka07paqdeTu0WR1IM4kNcpmBAUSHSQX0FslNhTDadL4O5SAGapGt4FodqL8My0mA==';
                script.crossOrigin = 'anonymous';
                script.referrerPolicy = 'no-referrer';
                
                script.onload = resolve;
                script.onerror = () => {
                    console.warn('QRCode library failed to load, using fallback');
                    resolve(); // Still resolve untuk melanjutkan dengan fallback
                };
                
                document.head.appendChild(script);
            });
        }

        /**
         * Load html2canvas library dynamically
         */
        function loadHtml2CanvasLibrary() {
            return new Promise((resolve, reject) => {
                if (typeof html2canvas !== 'undefined') {
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                script.integrity = 'sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA==';
                script.crossOrigin = 'anonymous';
                script.referrerPolicy = 'no-referrer';
                
                script.onload = resolve;
                script.onerror = () => {
                    console.warn('html2canvas library failed to load, download will use fallback');
                    resolve(); // Still resolve untuk melanjutkan dengan fallback
                };
                
                document.head.appendChild(script);
            });
        }

        // ============================================
        // INITIALIZE APP
        // ============================================

        // Load libraries terlebih dahulu, lalu inisialisasi app
        Promise.all([
            loadQRCodeLibrary(),
            loadHtml2CanvasLibrary()
        ]).then(() => {
            // Tunggu DOM siap
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializeApp);
            } else {
                initializeApp();
            }
        }).catch(error => {
            console.error('Failed to load libraries:', error);
            // Tetap jalankan app dengan fallback
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializeApp);
            } else {
                initializeApp();
            }
        });
    </script>
</body>
</html>
