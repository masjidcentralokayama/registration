<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Konfirmasi Registrasi - Buka Puasa Bersama 1447 H</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@400;500;600;700&family=Open+Sans:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<style>
/* RESET & BASE STYLES */
:root {
  --accent-green: #10a37f;
  --accent-gold: #d4af37;
  --accent-teal: #0f766e;
  --accent-dark: #1e293b;
  --accent-light: #f8fafc;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: 'Poppins', 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
  background: linear-gradient(135deg, #f7f7f8 0%, #f0f9ff 100%);
  color: var(--accent-dark);
  line-height: 1.6;
  min-height: 100vh;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

main {
  padding: 2rem 1rem;
  position: relative;
  overflow: hidden;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

.container {
  max-width: 520px;
  margin: 0 auto;
  position: relative;
  z-index: 1;
  flex: 1;
  display: flex;
  flex-direction: column;
}

/* DECORATIVE ELEMENTS */
.ornament-top {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 120px;
  background: linear-gradient(135deg, var(--accent-green) 0%, var(--accent-teal) 100%);
  clip-path: polygon(0 0, 100% 0, 100% 70%, 0 100%);
  z-index: 0;
  opacity: 0.9;
}

.ornament-bottom {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 80px;
  background: linear-gradient(135deg, var(--accent-teal) 0%, var(--accent-green) 100%);
  clip-path: polygon(0 30%, 100% 0, 100% 100%, 0 100%);
  z-index: 0;
  opacity: 0.9;
}

.islamic-pattern {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-image: 
    radial-gradient(circle at 10% 10%, rgba(16, 163, 127, 0.05) 1px, transparent 1px),
    radial-gradient(circle at 90% 90%, rgba(212, 175, 55, 0.05) 1px, transparent 1px);
  background-size: 30px 30px;
  z-index: 0;
}

/* HEADER STYLES */
.header {
  text-align: center;
  margin-bottom: 2.5rem;
  padding: 0 0.5rem;
  position: relative;
}

.success-icon {
  width: 100px;
  height: 100px;
  background: white;
  border-radius: 50%;
  margin: 0 auto 1.5rem;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 20px rgba(16, 163, 127, 0.15);
  border: 3px solid var(--accent-gold);
  position: relative;
  overflow: hidden;
  animation: successPulse 2s infinite;
}

@keyframes successPulse {
  0% { 
    transform: scale(1);
    box-shadow: 0 4px 20px rgba(16, 163, 127, 0.15);
  }
  50% { 
    transform: scale(1.05);
    box-shadow: 0 6px 25px rgba(16, 163, 127, 0.25);
  }
  100% { 
    transform: scale(1);
    box-shadow: 0 4px 20px rgba(16, 163, 127, 0.15);
  }
}

.success-icon i {
  font-size: 3.5rem;
  color: var(--accent-green);
}

.header h1 {
  margin: 0 0 1rem 0;
  font-size: 2rem;
  color: var(--accent-dark);
  font-weight: 700;
  letter-spacing: -0.01em;
  line-height: 1.3;
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  position: relative;
  display: inline-block;
}

.header h1::after {
  content: '';
  position: absolute;
  bottom: -10px;
  left: 50%;
  transform: translateX(-50%);
  width: 100px;
  height: 3px;
  background: linear-gradient(90deg, transparent, var(--accent-gold), transparent);
  border-radius: 2px;
}

.header .center-name {
  color: var(--accent-teal);
  font-weight: 600;
  font-size: 1.1rem;
  margin-bottom: 1rem;
  font-family: 'Poppins', sans-serif;
}

.header .subtitle {
  color: #64748b;
  font-size: 0.95rem;
  font-weight: 400;
  line-height: 1.6;
  margin-bottom: 1rem;
  max-width: 480px;
  margin-left: auto;
  margin-right: auto;
}

.success-message {
  background: linear-gradient(135deg, rgba(16, 163, 127, 0.1) 0%, rgba(15, 118, 110, 0.1) 100%);
  border-radius: 12px;
  padding: 1.25rem 1.5rem;
  margin: 1.5rem auto 0;
  max-width: 480px;
  border-left: 4px solid var(--accent-gold);
  font-size: 0.95rem;
  color: var(--accent-teal);
  line-height: 1.6;
  text-align: center;
  box-shadow: 0 4px 12px rgba(16, 163, 127, 0.1);
}

.success-message i {
  color: var(--accent-gold);
  margin-right: 8px;
}

.islamic-divider {
  text-align: center;
  margin: 1.5rem 0;
  position: relative;
}

.islamic-divider::before,
.islamic-divider::after {
  content: '';
  position: absolute;
  top: 50%;
  width: 30%;
  height: 1px;
  background: linear-gradient(90deg, transparent, var(--accent-gold), transparent);
}

.islamic-divider::before {
  left: 0;
}

.islamic-divider::after {
  right: 0;
}

.islamic-divider span {
  color: var(--accent-gold);
  font-size: 1.2rem;
  letter-spacing: 8px;
  display: inline-block;
  padding: 0 10px;
  background: var(--accent-light);
}

/* CARD STYLES */
.card {
  background: #ffffff;
  padding: 2.5rem;
  border-radius: 16px;
  border: 1px solid #e2e8f0;
  box-shadow: 0 8px 32px rgba(16, 163, 127, 0.08);
  margin-bottom: 2.5rem;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
  flex: 1;
}

.card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 4px;
  height: 100%;
  background: linear-gradient(180deg, var(--accent-green), var(--accent-gold));
}

/* REGISTRATION DATA */
.registration-id {
  background: linear-gradient(135deg, var(--accent-green) 0%, var(--accent-teal) 100%);
  color: white;
  padding: 1rem 1.5rem;
  border-radius: 12px;
  text-align: center;
  margin-bottom: 2rem;
  font-family: 'Poppins', sans-serif;
  font-weight: 600;
  letter-spacing: 1px;
  box-shadow: 0 4px 12px rgba(16, 163, 127, 0.2);
  position: relative;
  overflow: hidden;
}

.registration-id::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%);
  animation: shimmer 3s infinite;
}

@keyframes shimmer {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(100%); }
}

.registration-id-label {
  font-size: 0.9rem;
  opacity: 0.9;
  margin-bottom: 0.5rem;
  display: block;
}

.registration-id-value {
  font-size: 1.5rem;
  font-weight: 700;
}

/* DATA SUMMARY */
.data-summary {
  margin-bottom: 2.5rem;
}

.data-item {
  display: flex;
  margin-bottom: 1.25rem;
  padding-bottom: 1.25rem;
  border-bottom: 1px solid #e2e8f0;
  align-items: flex-start;
}

.data-item:last-child {
  border-bottom: none;
  margin-bottom: 0;
  padding-bottom: 0;
}

.data-icon {
  width: 40px;
  height: 40px;
  background: linear-gradient(135deg, rgba(16, 163, 127, 0.1) 0%, rgba(15, 118, 110, 0.1) 100%);
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: 1rem;
  flex-shrink: 0;
  color: var(--accent-teal);
  font-size: 1.1rem;
}

.data-content {
  flex: 1;
}

.data-label {
  font-size: 0.85rem;
  color: #64748b;
  font-weight: 500;
  margin-bottom: 0.25rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.data-value {
  font-size: 1rem;
  color: var(--accent-dark);
  font-weight: 600;
  line-height: 1.5;
}

/* QR CODE SECTION */
.qr-section {
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  border: 1.5px solid #e2e8f0;
  border-radius: 16px;
  padding: 2rem;
  margin: 2.5rem 0;
  text-align: center;
  position: relative;
  overflow: hidden;
}

.qr-section::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--accent-green), var(--accent-gold), var(--accent-teal));
}

.qr-title {
  font-size: 1.1rem;
  color: var(--accent-teal);
  font-weight: 600;
  margin-bottom: 1.5rem;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
}

.qr-title i {
  color: var(--accent-gold);
}

#qrcode {
  margin: 0 auto;
  padding: 1rem;
  background: white;
  border-radius: 12px;
  display: inline-block;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  border: 1px solid #e2e8f0;
}

.qr-hint {
  font-size: 0.85rem;
  color: #64748b;
  margin-top: 1rem;
  line-height: 1.5;
  max-width: 300px;
  margin-left: auto;
  margin-right: auto;
}

/* ACTION BUTTONS */
.action-buttons {
  display: flex;
  gap: 1rem;
  margin-top: 2.5rem;
}

.btn {
  flex: 1;
  padding: 1rem;
  border-radius: 12px;
  font-size: 0.95rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  font-family: 'Poppins', sans-serif;
  text-align: center;
  text-decoration: none;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  border: none;
}

.btn-primary {
  background: linear-gradient(135deg, var(--accent-green) 0%, var(--accent-teal) 100%);
  color: white;
  box-shadow: 0 4px 12px rgba(16, 163, 127, 0.2);
}

.btn-primary:hover {
  background: linear-gradient(135deg, var(--accent-teal) 0%, var(--accent-green) 100%);
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(16, 163, 127, 0.3);
}

.btn-secondary {
  background: white;
  color: var(--accent-teal);
  border: 2px solid var(--accent-teal);
  box-shadow: 0 4px 12px rgba(15, 118, 110, 0.1);
}

.btn-secondary:hover {
  background: linear-gradient(135deg, rgba(16, 163, 127, 0.05) 0%, rgba(15, 118, 110, 0.05) 100%);
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(15, 118, 110, 0.15);
}

/* INFO BOX */
.info-box {
  background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
  border: 1.5px solid #bae6fd;
  border-radius: 12px;
  padding: 1.5rem;
  margin: 2rem 0;
  color: #0369a1;
  font-size: 0.9rem;
  line-height: 1.6;
}

.info-box i {
  color: var(--accent-teal);
  margin-right: 8px;
  font-size: 1.1rem;
}

/* FOOTER */
footer {
  text-align: center;
  color: #64748b;
  font-size: 0.85rem;
  padding: 1.5rem 0;
  border-top: 1px solid #e2e8f0;
  margin-top: 3rem;
  position: relative;
}

.prayer-message {
  background: linear-gradient(135deg, rgba(212, 175, 55, 0.08) 0%, rgba(16, 163, 127, 0.08) 100%);
  border-radius: 12px;
  padding: 1rem 1.5rem;
  margin: 1rem auto 1.5rem;
  max-width: 500px;
  color: var(--accent-teal);
  font-style: italic;
  line-height: 1.6;
  font-size: 0.9rem;
  border: 1px solid rgba(212, 175, 55, 0.2);
}

footer .center-name {
  font-weight: 600;
  color: var(--accent-teal);
  margin-bottom: 0.5rem;
  font-size: 0.9rem;
}

footer .contact {
  margin-top: 0.75rem;
  font-size: 0.8rem;
  color: #94a3b8;
}

footer .contact a {
  color: var(--accent-green);
  text-decoration: none;
  transition: color 0.3s ease;
}

footer .contact a:hover {
  color: var(--accent-teal);
  text-decoration: underline;
}

/* LOADING */
.loading {
  text-align: center;
  padding: 2rem;
  color: var(--accent-teal);
}

.loading-spinner {
  display: inline-block;
  width: 2rem;
  height: 2rem;
  border: 3px solid rgba(16, 163, 127, 0.1);
  border-radius: 50%;
  border-top-color: var(--accent-green);
  animation: spin 1s ease-in-out infinite;
  margin-bottom: 1rem;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* RESPONSIVE */
@media (max-width: 640px) {
  main {
    padding: 1.5rem 1rem;
  }
  
  .card {
    padding: 1.75rem;
  }
  
  .header h1 {
    font-size: 1.7rem;
  }
  
  .success-icon {
    width: 80px;
    height: 80px;
  }
  
  .success-icon i {
    font-size: 2.5rem;
  }
  
  .action-buttons {
    flex-direction: column;
  }
  
  .qr-section {
    padding: 1.5rem;
  }
  
  .data-item {
    flex-direction: column;
  }
  
  .data-icon {
    margin-right: 0;
    margin-bottom: 0.75rem;
  }
}
</style>
</head>

<body>
<!-- Decorative Background Elements -->
<div class="ornament-top"></div>
<div class="ornament-bottom"></div>
<div class="islamic-pattern"></div>

<main>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="success-icon">
        <i class="fas fa-check-circle"></i>
      </div>
      
      <h1 id="pageTitle" 
          data-id="Pendaftaran Berhasil!"
          data-en="Registration Successful!"
          data-ja="登録が完了しました！"></h1>
      
      <div class="center-name" 
           data-id="Yayasan Ibadurrahman Islamic Center"
           data-en="Ibadurrahman Islamic Center Foundation"
           data-ja="イバドゥッラフマン・イスラムセンター財団"></div>
      
      <div class="success-message">
        <i class="fas fa-check-circle"></i>
        <span id="successMessage"
              data-id="Data Anda telah berhasil disimpan dalam sistem. Berikut adalah detail registrasi Anda:"
              data-en="Your data has been successfully saved in the system. Here are your registration details:"
              data-ja="データがシステムに正常に保存されました。こちらが登録詳細です："></span>
      </div>
    </div>

    <!-- Islamic Divider -->
    <div class="islamic-divider">
      <span>✦ ✦ ✦</span>
    </div>

    <!-- Registration Card -->
    <div class="card">
      <!-- Registration ID -->
      <div class="registration-id">
        <span class="registration-id-label" 
              data-id="Kode Registrasi"
              data-en="Registration Code"
              data-ja="登録コード"></span>
        <div class="registration-id-value" id="registrationId">IFTAR-0001-ABC</div>
      </div>

      <!-- Data Loading -->
      <div id="loadingData" class="loading">
        <div class="loading-spinner"></div>
        <div data-id="Memuat data registrasi..."
             data-en="Loading registration data..."
             data-ja="登録データを読み込んでいます..."></div>
      </div>

      <!-- Data Summary -->
      <div id="dataSummary" class="data-summary" style="display: none;">
        <div class="data-item">
          <div class="data-icon">
            <i class="fas fa-user"></i>
          </div>
          <div class="data-content">
            <div class="data-label"
                 data-id="Nama Lengkap"
                 data-en="Full Name"
                 data-ja="氏名"></div>
            <div class="data-value" id="fullName">-</div>
          </div>
        </div>

        <div class="data-item">
          <div class="data-icon">
            <i class="fas fa-envelope"></i>
          </div>
          <div class="data-content">
            <div class="data-label"
                 data-id="Email"
                 data-en="Email"
                 data-ja="メール"></div>
            <div class="data-value" id="email">-</div>
          </div>
        </div>

        <div class="data-item">
          <div class="data-icon">
            <i class="fas fa-phone"></i>
          </div>
          <div class="data-content">
            <div class="data-label"
                 data-id="Nomor Telepon"
                 data-en="Phone Number"
                 data-ja="電話番号"></div>
            <div class="data-value" id="phoneNumber">-</div>
          </div>
        </div>

        <div class="data-item">
          <div class="data-icon">
            <i class="fas fa-map-marker-alt"></i>
          </div>
          <div class="data-content">
            <div class="data-label"
                 data-id="Domisili"
                 data-en="Residence"
                 data-ja="居住地"></div>
            <div class="data-value" id="residence">-</div>
          </div>
        </div>

        <div class="data-item">
          <div class="data-icon">
            <i class="fas fa-users"></i>
          </div>
          <div class="data-content">
            <div class="data-label"
                 data-id="Total Kehadiran"
                 data-en="Total Attendees"
                 data-ja="総参加者数"></div>
            <div class="data-value" id="totalAttendees">-</div>
          </div>
        </div>
      </div>

      <!-- QR Code Section -->
      <div class="qr-section">
        <div class="qr-title">
          <i class="fas fa-qrcode"></i>
          <span data-id="Kode QR Registrasi"
                data-en="Registration QR Code"
                data-ja="登録QRコード"></span>
        </div>
        
        <div id="qrcode"></div>
        
        <div class="qr-hint"
             data-id="Simpan kode QR ini sebagai bukti registrasi Anda"
             data-en="Save this QR code as proof of your registration"
             data-ja="このQRコードを登録証明として保存してください"></div>
      </div>

      <!-- Info Box -->
      <div class="info-box">
        <i class="fas fa-info-circle"></i>
        <span id="infoText"
              data-id="Email konfirmasi telah dikirim ke alamat email Anda. Simpan bukti registrasi ini untuk ditunjukkan saat acara."
              data-en="A confirmation email has been sent to your email address. Save this registration proof to present at the event."
              data-ja="確認メールが送信されました。この登録証明をイベント当日に提示してください。"></span>
      </div>

      <!-- Action Buttons -->
      <div class="action-buttons">
        <button id="downloadBtn" class="btn btn-primary">
          <i class="fas fa-download"></i>
          <span data-id="Unduh QR Code"
                data-en="Download QR Code"
                data-ja="QRコードをダウンロード"></span>
        </button>
        
        <a href="index.html" class="btn btn-secondary">
          <i class="fas fa-home"></i>
          <span data-id="Kembali ke Beranda"
                data-en="Back to Home"
                data-ja="ホームに戻る"></span>
        </a>
      </div>
    </div>

    <!-- Footer with prayer message -->
    <footer>
      <div class="prayer-message"
           data-id="Semoga Allah memberkahi kita semua dalam ibadah puasa dan menjadikan buka puasa bersama ini penuh keberkahan. Aamiin."
           data-en="May Allah bless us all in our fasting worship and make this iftar gathering full of blessings. Ameen."
           data-ja="アッラーが私たちの断食の礼拝を祝福し、この集団イフタールを祝福に満ちたものにしてくださいますように。アーミーン。"></div>
      
      <div class="center-name" 
           data-id="© 2026 — Yayasan Ibadurrahman Islamic Center"
           data-en="© 2026 — Ibadurrahman Islamic Center Foundation"
           data-ja="© 2026 — イバドゥッラフマン・イスラムセンター財団"></div>
      
      <div class="contact">
        <span data-id="Untuk informasi lebih lanjut:"
              data-en="For more information:"
              data-ja="詳細については："></span>
        <a href="mailto:info@ibadurrahman.org">info@ibadurrahman.org</a>
      </div>
    </footer>
  </div>
</main>

<script>
// Configuration
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwvLVMIbhBThHJ8l3d4Rppo1GvDbgeVjELq8_zOtzD7WHaWIaEHhVqHqyVJpgiaiDzp/exec";

// Get URL parameters
const urlParams = new URLSearchParams(window.location.search);
const registrationId = urlParams.get('id') || 'IFTAR-0000-XXX';
const registrantName = urlParams.get('nama') || 'Nama Jamaah';
const registrantEmail = urlParams.get('email') || 'email@example.com';
const langParam = urlParams.get('lang') || 'id';

// Detect language
let lang = langParam;
if (!['id', 'en', 'ja'].includes(lang)) {
  // Auto-detect if invalid language
  const userLang = navigator.language || navigator.userLanguage;
  if (userLang.startsWith('ja')) { 
    lang = 'ja'; 
  } else if (userLang.startsWith('en')) { 
    lang = 'en'; 
  } else {
    lang = 'id';
  }
}

// DOM Elements
const registrationIdElement = document.getElementById('registrationId');
const fullNameElement = document.getElementById('fullName');
const emailElement = document.getElementById('email');
const phoneNumberElement = document.getElementById('phoneNumber');
const residenceElement = document.getElementById('residence');
const totalAttendeesElement = document.getElementById('totalAttendees');
const loadingDataElement = document.getElementById('loadingData');
const dataSummaryElement = document.getElementById('dataSummary');
const downloadBtn = document.getElementById('downloadBtn');
const qrcodeElement = document.getElementById('qrcode');

// Initialize multilingual text
function initMultilingual() {
  document.querySelectorAll('[data-id]').forEach(element => {
    const text = element.getAttribute(`data-${lang}`) || element.getAttribute('data-id');
    if (text && element.tagName !== 'INPUT' && element.tagName !== 'TEXTAREA' && element.tagName !== 'SELECT' && element.tagName !== 'OPTION') {
      element.textContent = text;
    }
  });
}

// Load registration details from Google Sheets
async function loadRegistrationDetails() {
  try {
    const response = await fetch(`${SCRIPT_URL}?action=get_registration&id=${encodeURIComponent(registrationId)}`);
    
    if (!response.ok) {
      throw new Error('Failed to fetch registration details');
    }
    
    const result = await response.json();
    
    if (result.status === 'success' && result.data) {
      const data = result.data;
      
      // Update UI with registration data
      registrationIdElement.textContent = data.id || registrationId;
      fullNameElement.textContent = data.nama_lengkap || registrantName;
      emailElement.textContent = data.email || registrantEmail;
      phoneNumberElement.textContent = data.no_hp || '-';
      residenceElement.textContent = data.domisili || '-';
      totalAttendeesElement.textContent = data.jumlah_orang_total || '1';
      
      // Hide loading, show data
      loadingDataElement.style.display = 'none';
      dataSummaryElement.style.display = 'block';
      
      // Generate QR Code with registration ID
      generateQRCode(data.id || registrationId);
      
    } else {
      // If no data from server, use URL parameters
      displayDefaultData();
    }
    
  } catch (error) {
    console.error('Error loading registration details:', error);
    // If error, use URL parameters
    displayDefaultData();
  }
}

// Display default data from URL parameters
function displayDefaultData() {
  registrationIdElement.textContent = registrationId;
  fullNameElement.textContent = registrantName;
  emailElement.textContent = registrantEmail;
  phoneNumberElement.textContent = '-';
  residenceElement.textContent = '-';
  totalAttendeesElement.textContent = '1';
  
  // Hide loading, show data
  loadingDataElement.style.display = 'none';
  dataSummaryElement.style.display = 'block';
  
  // Generate QR Code
  generateQRCode(registrationId);
}

// Generate QR Code
function generateQRCode(data) {
  // Clear previous QR code
  qrcodeElement.innerHTML = '';
  
  // Create new QR code
  new QRCode(qrcodeElement, {
    text: data,
    width: 200,
    height: 200,
    colorDark: "#0f766e",
    colorLight: "#ffffff",
    correctLevel: QRCode.CorrectLevel.H
  });
}

// Download QR Code as PNG
async function downloadQRCode() {
  try {
    // Show loading state
    const originalText = downloadBtn.innerHTML;
    downloadBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> <span data-id="Mengunduh..." data-en="Downloading..." data-ja="ダウンロード中..."></span>`;
    initMultilingual();
    
    // Get the QR code canvas
    const canvas = qrcodeElement.querySelector('canvas');
    
    if (!canvas) {
      throw new Error('QR Code canvas not found');
    }
    
    // Create a new canvas with better quality
    const newCanvas = document.createElement('canvas');
    newCanvas.width = 400;
    newCanvas.height = 450;
    const ctx = newCanvas.getContext('2d');
    
    // Background
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, newCanvas.width, newCanvas.height);
    
    // Add border
    ctx.strokeStyle = '#0f766e';
    ctx.lineWidth = 2;
    ctx.strokeRect(10, 10, newCanvas.width - 20, newCanvas.height - 20);
    
    // Add header
    ctx.fillStyle = '#0f766e';
    ctx.font = 'bold 18px Poppins, sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText(lang === 'id' ? 'BUKA PUASA BERSAMA 1447 H' : 
                 lang === 'en' ? 'RAMADAN IFTAR GATHERING 1447 AH' :
                 'ラマダン・イフタール集会 1447年', newCanvas.width / 2, 40);
    
    ctx.font = '14px Poppins, sans-serif';
    ctx.fillStyle = '#10a37f';
    ctx.fillText(lang === 'id' ? 'Yayasan Ibadurrahman Islamic Center' :
                 lang === 'en' ? 'Ibadurrahman Islamic Center Foundation' :
                 'イバドゥッラフマン・イスラムセンター財団', newCanvas.width / 2, 65);
    
    // Draw QR code
    ctx.drawImage(canvas, newCanvas.width / 2 - 100, 90, 200, 200);
    
    // Add registration info
    ctx.fillStyle = '#1e293b';
    ctx.font = 'bold 16px Poppins, sans-serif';
    ctx.fillText(registrationIdElement.textContent, newCanvas.width / 2, 320);
    
    ctx.font = '14px Poppins, sans-serif';
    ctx.fillStyle = '#64748b';
    ctx.fillText(fullNameElement.textContent, newCanvas.width / 2, 345);
    
    ctx.font = '12px Poppins, sans-serif';
    ctx.fillStyle = '#94a3b8';
    ctx.fillText(lang === 'id' ? 'Simpan sebagai bukti registrasi' :
                 lang === 'en' ? 'Save as registration proof' :
                 '登録証明として保存', newCanvas.width / 2, 370);
    
    // Add footer
    ctx.font = '10px Poppins, sans-serif';
    ctx.fillStyle = '#cbd5e1';
    ctx.fillText('© 2026 Ibadurrahman Islamic Center', newCanvas.width / 2, 430);
    
    // Convert to blob and download
    newCanvas.toBlob(function(blob) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      
      // Create filename: ID_BUKBER26_NamaJamaah.png
      const cleanName = fullNameElement.textContent
        .replace(/[^a-zA-Z0-9\u0600-\u06FF\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FFF\s]/g, '')
        .replace(/\s+/g, '_')
        .substring(0, 50);
      
      a.download = `${registrationIdElement.textContent}_${cleanName}.png`;
      
      // Trigger download
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      
      // Clean up
      URL.revokeObjectURL(url);
      
      // Restore button text
      downloadBtn.innerHTML = originalText;
      initMultilingual();
      
    }, 'image/png', 1.0);
    
  } catch (error) {
    console.error('Error downloading QR code:', error);
    
    // Fallback: download the original canvas
    const canvas = qrcodeElement.querySelector('canvas');
    if (canvas) {
      const url = canvas.toDataURL('image/png');
      const a = document.createElement('a');
      a.href = url;
      
      const cleanName = fullNameElement.textContent
        .replace(/[^a-zA-Z0-9\u0600-\u06FF\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FFF\s]/g, '')
        .replace(/\s+/g, '_')
        .substring(0, 50);
      
      a.download = `${registrationIdElement.textContent}_${cleanName}.png`;
      
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }
    
    // Restore button text
    downloadBtn.innerHTML = `<i class="fas fa-download"></i> <span data-id="Unduh QR Code" data-en="Download QR Code" data-ja="QRコードをダウンロード"></span>`;
    initMultilingual();
  }
}

// Initialize the page
function initPage() {
  // Set language
  initMultilingual();
  
  // Load registration details
  loadRegistrationDetails();
  
  // Set up download button
  downloadBtn.addEventListener('click', downloadQRCode);
  
  // Update page title
  const pageTitle = document.getElementById('pageTitle');
  const titleText = pageTitle.getAttribute(`data-${lang}`) || pageTitle.getAttribute('data-id');
  document.title = `${titleText} - ${registrationId}`;
}

// Start the application when DOM is loaded
document.addEventListener('DOMContentLoaded', initPage);
</script>
</body>
</html>
